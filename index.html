<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Astrology Rotation Tool</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body {
    background: #0f172a;
    color: #e5e7eb;
    font-family: Arial, sans-serif;
    padding: 20px;
  }
  h1 {
    font-size: 22px;
    margin-bottom: 10px;
  }
  select, button {
    background: #020617;
    color: #e5e7eb;
    border: 1px solid #334155;
    padding: 4px 8px;
    margin-right: 6px;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
  }
  th, td {
    border: 1px solid #334155;
    padding: 6px;
    text-align: center;
  }
  th {
    background: #020617;
  }
  select.deg-disabled {
    opacity: 0.4;
    pointer-events: none;
  }
</style>
</head>

<body>

<h1>Planet Rotation Tool (KP / Vedic)</h1>

<div>
  Rotate from:
  <select id="pivotSelect"></select>

  <label>
    <input type="checkbox" id="ignoreDegrees">
    Ignore Degrees
  </label>

  <label>
    <input type="checkbox" id="reverseCounting">
    Reverse Counting (Retrograde)
  </label>

  <label>
    <input type="radio" name="houseSystem" value="KP">
    KP
  </label>

  <label>
    <input type="radio" name="houseSystem" value="Vedic" checked>
    Vedic
  </label>

  <button id="clearBtn">Clear All</button>
  <button id="saveBtn">Save Chart</button>
  <button id="loadBtn">Load Chart</button>
  <input type="file" id="fileInput" accept=".json" hidden>
</div>

<table>
<thead>
<tr>
  <th>Planet</th>
  <th>Sign</th>
  <th>Degree</th>
  <th>House</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<script>
/* ======================= LOCKED LOGIC ZONE ======================= */

const SIGNS = [
  "Aries","Taurus","Gemini","Cancer","Leo","Virgo",
  "Libra","Scorpio","Sagittarius","Capricorn","Aquarius","Pisces"
];

const PLANETS = [
  "Lagna","Surya","Chandra","Mangala","Rahu",
  "Jupiter","Saturn","Budha","Ketu","Venus"
];

const data = {};
PLANETS.forEach(p => data[p] = { sign:"", degree:"" });

const pivotSelect = document.getElementById("pivotSelect");
const tableBody = document.getElementById("tableBody");
const ignoreDegreesChk = document.getElementById("ignoreDegrees");
const reverseChk = document.getElementById("reverseCounting");

let ignoreDegrees = false;
let houseSystem = "Vedic";
let reverseCounting = false;

/* Pivot dropdown */
PLANETS.forEach(p => {
  const opt = document.createElement("option");
  opt.value = p;
  opt.textContent = p;
  pivotSelect.appendChild(opt);
});

/* Build table */
function buildTable() {
  tableBody.innerHTML = "";

  const startIndex = PLANETS.indexOf(pivotSelect.value);
  const orderedPlanets = startIndex === -1
    ? PLANETS
    : [...PLANETS.slice(startIndex), ...PLANETS.slice(0, startIndex)];

  orderedPlanets.forEach(planet => {
    if (pivotSelect.value !== "Lagna" && planet === "Lagna") return;

    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${planet}</td>
      <td>
        <select data-p="${planet}" data-t="sign">
          <option value=""></option>
          ${SIGNS.map(s=>`<option>${s}</option>`).join("")}
        </select>
      </td>
      <td>
        <select data-p="${planet}" data-t="deg">
          <option value=""></option>
          ${Array.from({length:30},(_,i)=>`<option>${i}</option>`).join("")}
        </select>
      </td>
      <td id="out_${planet}"></td>
    `;
    tableBody.appendChild(tr);
  });

  tableBody.querySelectorAll("select").forEach(sel => {
    const p = sel.dataset.p;

    if (sel.dataset.t === "sign") {
      sel.value = data[p].sign;
    } else {
      sel.value = data[p].degree;
      sel.classList.toggle("deg-disabled", ignoreDegrees);
    }

    sel.onchange = () => {
      if (sel.dataset.t === "sign") data[p].sign = sel.value;
      else data[p].degree = sel.value;
      recalc();
    };
  });
}

function absDegree(sign, degree) {
  return SIGNS.indexOf(sign) * 30 + degree;
}

function recalc() {
  const pivot = pivotSelect.value;
  const pivotData = data[pivot];
  if (!pivotData.sign || pivotData.degree === "") {
    clearOutputs();
    return;
  }

  const pivotAbs = absDegree(pivotData.sign, Number(pivotData.degree));

  PLANETS.forEach(p => {
    const out = document.getElementById("out_" + p);
    if (!out) return;

    const d = data[p];
    if (!d.sign) {
      out.textContent = "";
      return;
    }

    const usedDegree = ignoreDegrees ? pivotData.degree : d.degree;
    if (usedDegree === "") {
      out.textContent = "";
      return;
    }

    const planetAbs = absDegree(d.sign, Number(usedDegree));

    let diff = reverseCounting
      ? pivotAbs - planetAbs
      : planetAbs - pivotAbs;

    if (diff < 0) diff += 360;

    let house;
    if (houseSystem === "Vedic") {
      house = Math.floor((diff + 15) / 30) + 1;
      if (house > 12) house -= 12;
    } else {
      house = Math.floor(diff / 30) + 1;
    }

    out.textContent = house;
  });
}

function clearOutputs() {
  PLANETS.forEach(p => {
    const out = document.getElementById("out_" + p);
    if (out) out.textContent = "";
  });
}

pivotSelect.onchange = () => {
  buildTable();
  recalc();
};

buildTable();

/* ======================= EXTRA FEATURES ======================= */

ignoreDegreesChk.onchange = () => {
  ignoreDegrees = ignoreDegreesChk.checked;
  buildTable();
  recalc();
};

reverseChk.onchange = () => {
  reverseCounting = reverseChk.checked;
  recalc();
};

document.querySelectorAll('input[name="houseSystem"]').forEach(r => {
  r.onchange = () => {
    houseSystem = r.value;
    recalc();
  };
});

/* ðŸ”’ CLEAR ALL WITH WARNING */
document.getElementById("clearBtn").onclick = () => {
  const confirmClear = confirm(
    "âš ï¸ Are you sure you want to clear the entire chart?\n\nThis action cannot be undone."
  );

  if (!confirmClear) return;

  PLANETS.forEach(p => {
    data[p].sign = "";
    data[p].degree = "";
  });

  buildTable();
  clearOutputs();
};

document.getElementById("saveBtn").onclick = () => {
  const payload = { pivot: pivotSelect.value, ignoreDegrees, reverseCounting, houseSystem, data };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type:"application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "kundali_chart.json";
  a.click();
};

document.getElementById("loadBtn").onclick = () => {
  document.getElementById("fileInput").click();
};

document.getElementById("fileInput").onchange = e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    const obj = JSON.parse(reader.result);
    pivotSelect.value = obj.pivot;
    ignoreDegrees = !!obj.ignoreDegrees;
    reverseCounting = !!obj.reverseCounting;
    houseSystem = obj.houseSystem || "Vedic";
    ignoreDegreesChk.checked = ignoreDegrees;
    reverseChk.checked = reverseCounting;
    document.querySelector(`input[value="${houseSystem}"]`).checked = true;
    Object.assign(data, obj.data);
    buildTable();
    recalc();
  };
  reader.readAsText(file);
};
</script>

</body>
</html>
