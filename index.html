<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Astrology Rotation Tool</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body{background:#0f172a;color:#e5e7eb;font-family:Arial,sans-serif;padding:20px}
  h1{font-size:22px;margin-bottom:10px}
  select,button{background:#020617;color:#e5e7eb;border:1px solid #334155;padding:4px 8px;margin-right:6px}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #334155;padding:6px;text-align:center}
  th{background:#020617}
  select.deg-disabled{opacity:.4;pointer-events:none}
  .aspect-good{color:#22c55e;font-weight:600}
  .aspect-bad{color:#ef4444;font-weight:600}
  .aspect-neutral{color:#e5e7eb;font-weight:600}
</style>
</head>

<body>

<h1>Planet Rotation Tool (KP / Vedic)</h1>

<div>
  Rotate from:
  <select id="pivotSelect"></select>

  <label><input type="checkbox" id="ignoreDegrees"> Ignore Degrees</label>
  <label><input type="checkbox" id="reverseCounting"> Retro</label>
  <label><input type="checkbox" id="legacyOppConj" checked> Subtract 180°</label>
  <label><input type="checkbox" id="showRawDegrees"> (0–360)</label>
  <label><input type="checkbox" id="pivotRowFromLagna" checked> Actual Position</label>

  <label><input type="radio" name="houseSystem" value="KP"> KP</label>
  <label><input type="radio" name="houseSystem" value="Vedic" checked> Vedic</label>

  <button id="clearBtn">Clear All</button>
  <button id="saveBtn">Save Chart</button>
  <button id="loadBtn">Load Chart</button>
  <input type="file" id="fileInput" accept=".json" hidden>
</div>

<table>
<thead>
<tr>
  <th>Planet</th>
  <th>Sign</th>
  <th>Degree</th>
  <th>House</th>
  <th>Degree Difference</th>
  <th>Aspect</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

<script>
const SIGNS=["Aries","Taurus","Gemini","Cancer","Leo","Virgo","Libra","Scorpio","Sagittarius","Capricorn","Aquarius","Pisces"];
const PLANETS=["Lagna","Surya","Chandra","Mangala","Rahu","Jupiter","Saturn","Budha","Ketu","Venus"];

const BENEFIC_PLANETS=["Jupiter","Venus","Budha","Chandra"];
const MALEFIC_PLANETS=["Saturn","Mangala","Rahu","Ketu","Surya"];

const data={}; PLANETS.forEach(p=>data[p]={sign:"",degree:""});

const pivotSelect=document.getElementById("pivotSelect");
const tableBody=document.getElementById("tableBody");
const ignoreDegreesChk=document.getElementById("ignoreDegrees");
const reverseChk=document.getElementById("reverseCounting");
const legacyOppConjChk=document.getElementById("legacyOppConj");
const showRawDegreesChk=document.getElementById("showRawDegrees");
const pivotRowChk=document.getElementById("pivotRowFromLagna");
const fileInput=document.getElementById("fileInput");

let ignoreDegrees=false;
let houseSystem="Vedic";
let reverseCounting=false;
let pivotRowFromLagna=true;
let legacyOppConj=true;
let showRawDegrees=false;
let currentAspectPlanet="";

PLANETS.forEach(p=>{
  const o=document.createElement("option");
  o.value=p;o.textContent=p;
  pivotSelect.appendChild(o);
});
pivotSelect.value="Lagna";

function buildTable(){
  tableBody.innerHTML="";
  const start=PLANETS.indexOf(pivotSelect.value);
  const ordered=[...PLANETS.slice(start),...PLANETS.slice(0,start)];
  ordered.forEach(p=>{
    if(pivotSelect.value!=="Lagna"&&p==="Lagna")return;
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${p}</td>
      <td><select data-p="${p}" data-t="sign"><option></option>${SIGNS.map(s=>`<option>${s}</option>`).join("")}</select></td>
      <td><select data-p="${p}" data-t="deg"><option></option>${[...Array(30).keys()].map(i=>`<option>${i}</option>`).join("")}</select></td>
      <td id="out_${p}"></td>
      <td id="degdiff_${p}"></td>
      <td id="aspect_${p}"></td>`;
    tableBody.appendChild(tr);
  });

  tableBody.querySelectorAll("select").forEach(sel=>{
    const p=sel.dataset.p;
    if(sel.dataset.t==="sign")sel.value=data[p].sign;
    else{sel.value=data[p].degree;sel.classList.toggle("deg-disabled",ignoreDegrees);}
    sel.onchange=()=>{
      if(sel.dataset.t==="sign")data[p].sign=sel.value;
      else data[p].degree=sel.value;
      recalc();
    };
  });
}

function absDegree(s,d){return SIGNS.indexOf(s)*30+d;}

function recalc(){
  const pivot=pivotSelect.value;
  if(!data[pivot].sign||data[pivot].degree===""){clearOutputs();return;}

  const pivotAbs=absDegree(data[pivot].sign,+data[pivot].degree);
  const lagnaAbs=data.Lagna.sign
    ? absDegree(data.Lagna.sign,+data.Lagna.degree)
    : null;

  PLANETS.forEach(p=>{
    const out=document.getElementById("out_"+p);
    const degOut=document.getElementById("degdiff_"+p);
    const aspOut=document.getElementById("aspect_"+p);
    if(!out)return;
    if(!data[p].sign||data[p].degree===""){out.textContent=degOut.textContent=aspOut.textContent="";return;}

    const planetAbs=absDegree(data[p].sign,+data[p].degree);

    let rawDiff=planetAbs-pivotAbs;
    if(rawDiff<0)rawDiff+=360;

    if(reverseCounting){
      rawDiff=360-rawDiff;
      if(rawDiff===360)rawDiff=0;
    }

    let displayDiff;
    if(showRawDegrees){
      displayDiff=rawDiff;
    }else if(legacyOppConj){
      displayDiff=rawDiff>180?rawDiff-180:rawDiff;
    }else{
      displayDiff=rawDiff>180?360-rawDiff:rawDiff;
    }
    degOut.textContent=displayDiff+"°";

    currentAspectPlanet=p;
    aspOut.innerHTML=getAspectLabel(displayDiff,rawDiff,pivot);

    let houseDiff = reverseCounting
      ? pivotAbs - planetAbs
      : planetAbs - pivotAbs;
    if(houseDiff<0)houseDiff+=360;

    let house=houseSystem==="Vedic"
      ? Math.floor((houseDiff+15)/30)+1
      : Math.floor(houseDiff/30)+1;
    if(house>12)house-=12;

    if(pivotRowFromLagna && p===pivot && pivot!=="Lagna" && lagnaAbs!==null){
      let f=planetAbs-lagnaAbs;
      if(f<0)f+=360;
      house=houseSystem==="Vedic"
        ? Math.floor((f+15)/30)+1
        : Math.floor(f/30)+1;
      if(house>12)house-=12;
    }

    out.textContent=house;
  });
}

function clearOutputs(){
  PLANETS.forEach(p=>{
    ["out_","degdiff_","aspect_"].forEach(id=>{
      const e=document.getElementById(id+p);
      if(e)e.textContent="";
    });
  });
}

pivotSelect.onchange=()=>{buildTable();recalc();};
buildTable();

ignoreDegreesChk.onchange=()=>{ignoreDegrees=ignoreDegreesChk.checked;buildTable();recalc();};
reverseChk.onchange=()=>{reverseCounting=reverseChk.checked;recalc();};
legacyOppConjChk.onchange=()=>{legacyOppConj=legacyOppConjChk.checked;recalc();};
showRawDegreesChk.onchange=()=>{showRawDegrees=showRawDegreesChk.checked;recalc();};
pivotRowChk.onchange=()=>{pivotRowFromLagna=pivotRowChk.checked;recalc();};
document.querySelectorAll('input[name="houseSystem"]').forEach(r=>r.onchange=()=>{houseSystem=r.value;recalc();});

document.getElementById("clearBtn").onclick=()=>{
  if(!confirm("⚠️ Are you sure you want to clear the entire chart?"))return;
  PLANETS.forEach(p=>data[p]={sign:"",degree:""});
  pivotSelect.value="Lagna";
  legacyOppConj=true; legacyOppConjChk.checked=true;
  showRawDegrees=false; showRawDegreesChk.checked=false;
  buildTable(); clearOutputs();
};

document.getElementById("saveBtn").onclick=()=>{
  const b=new Blob([JSON.stringify({
    pivot:pivotSelect.value,
    ignoreDegrees,
    reverseCounting,
    legacyOppConj,
    showRawDegrees,
    houseSystem,
    pivotRowFromLagna,
    data
  },null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download="kundali_chart.json";
  a.click();
};

document.getElementById("loadBtn").onclick=()=>fileInput.click();
fileInput.onchange=e=>{
  const r=new FileReader();
  r.onload=()=>{
    const o=JSON.parse(r.result);
    pivotSelect.value=o.pivot||"Lagna";
    Object.assign(data,o.data||{});
    ignoreDegrees=o.ignoreDegrees||false;
    reverseCounting=o.reverseCounting||false;
    legacyOppConj=o.legacyOppConj!==false;
    showRawDegrees=o.showRawDegrees||false;
    houseSystem=o.houseSystem||"Vedic";
    pivotRowFromLagna=o.pivotRowFromLagna!==false;

    ignoreDegreesChk.checked=ignoreDegrees;
    reverseChk.checked=reverseCounting;
    legacyOppConjChk.checked=legacyOppConj;
    showRawDegreesChk.checked=showRawDegrees;
    pivotRowChk.checked=pivotRowFromLagna;
    document.querySelector(`input[value="${houseSystem}"]`).checked=true;

    buildTable(); recalc();
  };
  r.readAsText(e.target.files[0]);
};
</script>

<script>
const WESTERN_ASPECTS=[
{d:0,o:8,n:"Conjunction",t:"neutral"},
{d:18,o:1,n:"Vigintile",t:"good"},
{d:22.5,o:.5,n:"Semi-Octile",t:"bad"},
{d:30,o:3,n:"Semi-Sextile",t:"bad"},
{d:36,o:1,n:"Decile",t:"good"},
{d:40,o:1,n:"Novile",t:"good"},
{d:45,o:3,n:"Semi-Square",t:"bad"},
{d:51.43,o:1.5,n:"Septile",t:"neutral"},
{d:54,o:1,n:"Tridecile (54°)",t:"good"},
{d:60,o:5,n:"Sextile",t:"good"},
{d:67.5,o:1,n:"Sesquile",t:"bad"},
{d:72,o:2,n:"Quintile",t:"good"},
{d:80,o:1,n:"Binovile",t:"good"},
{d:90,o:8,n:"Square",t:"bad"},
{d:102.86,o:1.5,n:"Biseptile",t:"neutral"},
{d:105,o:1,n:"Squine",t:"bad"},
{d:108,o:1,n:"Tridecile",t:"good"},
{d:120,o:10,n:"Trine",t:"good"},
{d:135,o:3,n:"Sesquiquadrate",t:"bad"},
{d:144,o:2,n:"Bi-Quintile",t:"good"},
{d:150,o:4,n:"Quincunx",t:"bad"},
{d:154.29,o:1.5,n:"Triseptile",t:"neutral"},
{d:160,o:1,n:"Quadnovile",t:"neutral"},
{d:165,o:2,n:"Quindecile",t:"bad"},
{d:180,o:8,n:"Opposition",t:"neutral"}
];

function getConjOppClass(p1,p2){
  const b1=BENEFIC_PLANETS.includes(p1);
  const b2=BENEFIC_PLANETS.includes(p2);
  const m1=MALEFIC_PLANETS.includes(p1);
  const m2=MALEFIC_PLANETS.includes(p2);
  if(m1&&m2)return "aspect-bad";
  if(b1&&b2)return "aspect-good";
  return "aspect-neutral";
}

function getAspectLabel(diff,rawDiff,pivot){
  for(const a of WESTERN_ASPECTS){
    let orb=a.o;
    if(a.d===0 && diff<=orb){
      return `<span class="${getConjOppClass(currentAspectPlanet,pivot)}">${a.n}</span>`;
    }
    if(a.d===180 && Math.abs(rawDiff-180)<=orb){
      return `<span class="${getConjOppClass(currentAspectPlanet,pivot)}">${a.n}</span>`;
    }
    if(Math.abs(diff-a.d)<=orb){
      if(a.t==="good")return `<span class="aspect-good">${a.n}</span>`;
      if(a.t==="bad")return `<span class="aspect-bad">${a.n}</span>`;
      return `<span class="aspect-neutral">${a.n}</span>`;
    }
  }
  return "";
}
</script>

</body>
</html>
